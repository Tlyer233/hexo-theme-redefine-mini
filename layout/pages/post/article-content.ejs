<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			<% if (page.cover || page.banner || (page.thumbnail && page.thumbnail !== false)) { %>
			<% let articleCover = "";
                if (page.cover && page.cover.includes("/")) {
                articleCover = page.cover;
                } else if (page.banner && page.banner.includes("/")) {
                articleCover = page.banner;
                } else if (page.thumbnail && page.thumbnail !== null) {
                articleCover = page.thumbnail;
                } else if (config.marked.postAsset && config.marked.postAsset == true) {
                articleCover = [page.path, page.cover || page.banner].join("/");
                }
                %>
			<% if (articleCover) { %>
			<img src="<%= url_for(articleCover) %>" alt="<%= page.title %>" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75" />
			<% } %>
			<div class="w-full flex items-center absolute bottom-0 <%= theme.articles.style.title_alignment === "center" ? "justify-center" : "justify-start" %>">
				<h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-semibold backdrop-blur-lg rounded-xl border border-border-color "><%= page.title %></h1>
			</div>
			<% } else { %>
			<div class="w-full flex items-center pt-6 <%= theme.articles.style.title_alignment === "center" ? "justify-center" : "justify-start" %>">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3"><%= page.title %></h1>
			</div>
			<% } %>
		</div>

		<% if (theme.info.author || config.author) { %>
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<%- image_tag((typeof page.avatar === "string" && (page.avatar)) || page.author?.avatar || theme.defaults.avatar) %>
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold"><%= (typeof page.author === "string" && (page.author)) || page.author?.name || theme.info.author || config.author %></span>
					<% if (theme.hasOwnProperty('articles') && theme.articles.author_label.enable === true) { %>
					<span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1"><%- getAuthorLabel(site.posts.length, theme.articles.author_label.auto, theme.articles.author_label.list) %></span>
					<% } %>
				</div>
				<div class="meta-info">
					<%- partial('pages/post/article-info', {articleObject: page, index: true}) %>
				</div>
			</div>
		</div>
		<% } else { %>
		<div class="article-header-meta-info px-2 sm:px-6 md:px-8">
			<div class="meta-info">
				<%- partial('pages/post/article-info', {articleObject: page, index: true}) %>
			</div>
		</div>
		<% } %>

		<% if (page?.expires && page?.expires !== "") {%>
		<div class="article-expire mt-4 mx-2 sm:mx-6 md:mx-8 note p-4 rounded-lg red icon hidden" id="expiration-container">
			<i class="expire-icon fa-solid fa-timer mr-0.5 text-red-600 dark:text-red-400"></i>
			<span class="expire-label text-red-600 dark:text-red-400 " id="expiration-date"><%= __('expired', "some") %></span>
		</div>

		<script data-swup-reload-script>
			function updateExpirationDate() {
				try {
					const expiredDate = new Date("<%= page?.expires %>");
					const updatedDate = new Date("<%= page?.updated %>");
					const now = new Date();
					const expirationValue = document.getElementById("expiration-date");
					const expirationContainer = document.getElementById("expiration-container");
					let daysAgo = Math.floor((now - updatedDate) / (1000 * 60 * 60 * 24));
					if (expiredDate < now) {
						expirationContainer.classList.remove("hidden");
						// console.log(daysAgo)
						expirationValue.innerHTML = expirationValue.innerHTML.replace("some", daysAgo);
					}
				} catch (e) {}
			}
			document.addEventListener("DOMContentLoaded", function() {
				updateExpirationDate();
			});
			try {
				swup.hooks.on("page:view", updateExpirationDate)
			} catch (e) {}
		</script>
		<% } %>


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<%- page.content %>
		</div>

		<% if (theme.articles.copyright.enable || theme.articles.copyright === true) { %>
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<%- partial('pages/post/article-copyright') %>
		</div>
		<% } %>

		<% if (page?.tags?.length) { %>
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			<% page.tags.forEach((tag) => { %>
			<li class="tag-item mx-0.5">
				<a href="<%- url_for(tag.path) %>">#<%= tag.name %></a>&nbsp;
			</li>
			<% }); %>
		</ul>
		<% } %>

		<%- articleRecommendationGenerator(page) %>

		<% if (page?.prev || page?.next) { %>
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			<% if (page?.prev) { %>
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="<%= url_for(page.prev.path) %>">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item"><%= page.prev.title %></span>
						<span class="post-nav-item"><%= __('prev_posts') %></span>
					</span>
				</a>
			</div>
			<% } %>
			<% if (page?.next) { %>
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="<%= url_for(page.next.path) %>">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item"><%= page.next.title %></span>
						<span class="post-nav-item"><%= __('next_posts') %></span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			<% } %>
		</div>
		<% } %>


		<% if (theme.comment.enable === true && theme.comment.hasOwnProperty('system') && page.comment !== false) { %>
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<%- partial('components/comments/comment') %>
		</div>
		<% } %>
	</div>

	<% if (is_post() && theme.articles.toc.enable === true) { %>
	<div class="toc-resizer" id="tocResizer"></div>
	<div class="toc-content-container" id="tocContainer">
		<%- partial('pages/post/toc') %>
	</div>
	<% } %>
</div>

<style>
.toc-resizer {
	width: 6px;
	cursor: col-resize;
	background: transparent;
	position: relative;
	z-index: 10;
	flex-shrink: 0;
	transition: background 0.2s ease;
}

.toc-resizer:hover,
.toc-resizer.resizing {
	background: var(--redefine-theme-primary-color, #A31F34);
}

.toc-resizer::before {
	content: '';
	position: absolute;
	left: -4px;
	right: -4px;
	top: 0;
	bottom: 0;
}

.toc-content-container.toc-hidden {
	display: none !important;
	width: 0 !important;
	opacity: 0 !important;
}

.post-page-container.toc-collapsed {
	gap: 0 !important;
}

.post-page-container.toc-collapsed .toc-resizer {
	display: none;
}

.post-page-container.toc-collapsed .article-content-container {
	width: 100% !important;
}

/* 显示/隐藏按钮 */
.toc-toggle-btn {
	position: fixed;
	right: 20px;
	top: 50%;
	transform: translateY(-50%);
	width: 24px;
	height: 48px;
	background: var(--background-color);
	border: 1px solid var(--border-color);
	border-radius: 4px;
	cursor: pointer;
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 100;
	box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	transition: all 0.2s ease;
}

.toc-toggle-btn:hover {
	background: var(--redefine-theme-primary-color, #A31F34);
	color: white;
}

.post-page-container.toc-collapsed .toc-toggle-btn {
	display: flex;
}
</style>

<script data-swup-reload-script>
(function() {
	let isResizing = false;
	let startX = 0;
	let startWidth = 0;
	let resizer = null;
	let tocContainer = null;
	let postContainer = null;
	let articleContainer = null;
	const minWidth = 50;
	const defaultWidth = 210;
	
	// 鼠标移动处理函数
	function handleMouseMove(e) {
		if (!isResizing || !tocContainer || !postContainer || !articleContainer) return;
		
		// 向左拖拽增加宽度，向右拖拽减少宽度
		const diff = startX - e.clientX;
		let newWidth = startWidth + diff;
		
		// 限制最大宽度为容器的50%
		const maxWidth = postContainer.offsetWidth * 0.5;
		newWidth = Math.min(newWidth, maxWidth);
		
		if (newWidth < minWidth) {
			// 达到阈值，隐藏目录
			hideToc();
		} else {
			tocContainer.style.setProperty('width', newWidth + 'px', 'important');
			articleContainer.style.setProperty('width', 'calc(100% - ' + newWidth + 'px)', 'important');
		}
	}
	
	// 鼠标释放处理函数
	function handleMouseUp() {
		if (isResizing && resizer) {
			isResizing = false;
			resizer.classList.remove('resizing');
			document.body.style.cursor = '';
			document.body.style.userSelect = '';
			
			// 保存宽度
			if (tocContainer && !tocContainer.classList.contains('toc-hidden')) {
				localStorage.setItem('tocWidth', tocContainer.offsetWidth);
				localStorage.setItem('tocHidden', 'false');
			}
		}
	}
	
	// 恢复TOC到默认大小的函数
	function restoreToc() {
		if (!postContainer || !tocContainer || !articleContainer) return;
		postContainer.classList.remove('toc-collapsed');
		tocContainer.classList.remove('toc-hidden');
		postContainer.classList.add('show-toc');
		tocContainer.style.setProperty('width', defaultWidth + 'px', 'important');
		articleContainer.style.setProperty('width', 'calc(100% - ' + defaultWidth + 'px)', 'important');
		localStorage.setItem('tocWidth', defaultWidth);
		localStorage.setItem('tocHidden', 'false');
	}
	
	// 隐藏TOC的函数
	function hideToc() {
		if (!postContainer || !tocContainer) return;
		postContainer.classList.add('toc-collapsed');
		tocContainer.classList.add('toc-hidden');
		postContainer.classList.remove('show-toc');
		localStorage.setItem('tocHidden', 'true');
	}
	
	function initTocResizer() {
		resizer = document.getElementById('tocResizer');
		tocContainer = document.getElementById('tocContainer');
		postContainer = document.querySelector('.post-page-container');
		articleContainer = document.querySelector('.article-content-container');
		
		if (!resizer || !tocContainer || !postContainer || !articleContainer) {
			return;
		}
		
		// 从localStorage读取保存的宽度
		const savedWidth = localStorage.getItem('tocWidth');
		const isTocHidden = localStorage.getItem('tocHidden') === 'true';
		
		if (isTocHidden) {
			postContainer.classList.add('toc-collapsed');
			tocContainer.classList.add('toc-hidden');
		} else if (savedWidth) {
			tocContainer.style.setProperty('width', savedWidth + 'px', 'important');
			articleContainer.style.setProperty('width', 'calc(100% - ' + savedWidth + 'px)', 'important');
		}
		
		// 创建恢复按钮
		let toggleBtn = document.querySelector('.toc-toggle-btn');
		if (!toggleBtn) {
			toggleBtn = document.createElement('div');
			toggleBtn.className = 'toc-toggle-btn';
			toggleBtn.innerHTML = '<i class="fa-solid fa-angles-left"></i>';
			toggleBtn.title = '展开目录';
			postContainer.appendChild(toggleBtn);
			
			toggleBtn.addEventListener('click', function() {
				restoreToc();
			});
		}
		
		// 监听 page-aside-toggle 按钮的点击
		const pageAsideToggle = document.querySelector('.page-aside-toggle');
		if (pageAsideToggle) {
			// 移除旧的监听器（如果存在）
			pageAsideToggle.removeEventListener('click', handlePageAsideToggle);
			// 添加新的监听器
			pageAsideToggle.addEventListener('click', handlePageAsideToggle);
		}
		
		// 移除旧的鼠标按下监听器（如果存在）
		resizer.removeEventListener('mousedown', handleMouseDown);
		// 添加新的监听器
		resizer.addEventListener('mousedown', handleMouseDown);
	}
	
	// page-aside-toggle 点击处理函数
	function handlePageAsideToggle() {
		// 延迟执行，确保 show-toc 类已经被添加/移除
		setTimeout(function() {
			if (postContainer && postContainer.classList.contains('show-toc')) {
				// TOC 要展开 - 如果被隐藏了，恢复它
				if (postContainer.classList.contains('toc-collapsed') || 
					(tocContainer && tocContainer.classList.contains('toc-hidden'))) {
					restoreToc();
				}
			} else {
				// TOC 要隐藏 - 同步隐藏状态
				hideToc();
			}
		}, 50);
	}
	
	// 鼠标按下处理函数
	function handleMouseDown(e) {
		if (!tocContainer) return;
		isResizing = true;
		startX = e.clientX;
		startWidth = tocContainer.offsetWidth;
		resizer.classList.add('resizing');
		document.body.style.cursor = 'col-resize';
		document.body.style.userSelect = 'none';
		e.preventDefault();
	}
	
	// 添加全局事件监听器（只添加一次）
	document.removeEventListener('mousemove', handleMouseMove);
	document.removeEventListener('mouseup', handleMouseUp);
	document.addEventListener('mousemove', handleMouseMove);
	document.addEventListener('mouseup', handleMouseUp);
	
	// 初始化
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initTocResizer);
	} else {
		initTocResizer();
	}
	
	try {
		swup.hooks.on('page:view', function() {
			// 延迟初始化，确保DOM已经更新
			setTimeout(initTocResizer, 100);
		});
	} catch(e) {}
})();
</script>